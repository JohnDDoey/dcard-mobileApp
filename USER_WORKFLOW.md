# üë§ DCARD - Workflow Utilisateur Complet

## üéØ Vue d'ensemble

DCARD est une application de transfert d'argent avec syst√®me de cashback d√©centralis√© sur blockchain (zkSync Era).

## üîÑ Parcours Utilisateur Complet

---

### 1Ô∏è‚É£ **INSCRIPTION / CONNEXION**

#### Page : `/login`

**Inscription (Register) :**
1. User clique sur "Log In / Sign Up" depuis la page d'accueil
2. Remplit le formulaire :
   - Nom complet
   - Email
   - Mot de passe
3. Clique sur "Register"
4. **Backend** :
   - Hash le mot de passe (bcrypt)
   - Cr√©e l'utilisateur en DB
   - G√©n√®re un **userId unique**
   - Retourne un **JWT** avec le userId
5. User est automatiquement connect√©
6. Redirection vers page d'accueil

**Connexion (Login) :**
1. User entre email + mot de passe
2. Backend v√©rifie les credentials
3. Si valide ‚Üí JWT g√©n√©r√© avec userId
4. Redirection vers page d'accueil

**Donn√©es dans le JWT :**
```json
{
  "id": "12345",        // userId (mapp√© au smart contract)
  "email": "user@example.com",
  "name": "John Doe"
}
```

---

### 2Ô∏è‚É£ **ENVOI D'ARGENT (Send Money)**

#### Page : `/send-money` (üîí Prot√©g√©e - n√©cessite connexion)

#### **√âtape 1 : Estimate**
1. User s√©lectionne le pays du b√©n√©ficiaire
2. Entre le montant √† envoyer (EUR)
3. Voit la conversion (EUR ‚Üí XAF)
4. Clique "Continue"

**Donn√©es collect√©es :**
```javascript
{
  amountSent: "10000",
  amountReceived: "6559570.00",
  currencySent: "EUR",
  currencyReceived: "XAF",
  exchangeRate: "655.957"
}
```

#### **√âtape 2 : Receiver Information**
1. User entre les informations du b√©n√©ficiaire :
   - Pr√©nom
   - Nom
   - Num√©ro de t√©l√©phone
   - Ville
2. Le pays est pr√©-rempli (de l'√©tape 1)
3. Clique "Continue"

**Donn√©es collect√©es :**
```javascript
{
  firstName: "Julienn",
  lastName: "Blot",
  phoneNumber: "+2691234567",
  city: "Moroni"
}
```

#### **√âtape 3 : Payment**
1. User voit le r√©sum√© de la transaction
2. Choisit une m√©thode de paiement :
   - Credit Card
   - PayPal
   - Google Pay
   - Bank Transfer
3. Entre les d√©tails de paiement (si carte)
4. Clique "Continue to Review"

**üî• CE QUI SE PASSE (CRUCIAL) :**

```javascript
// 1. VALIDATION DU PAIEMENT
const paymentResult = await processPayment(...);

// 2. SI PAIEMENT VALID√â ‚úÖ
if (paymentResult.success) {
  // G√©n√©rer le code coupon unique
  const couponCode = generateCouponCode();
  // Ex: "DCARD-1728567890-A5X9K"
  
  // R√©cup√©rer userId depuis JWT
  const userId = parseInt(session.user.id); // Ex: 12345
  
  // Enregistrer on-chain (Backend API paie les gas fees)
  await recordCashback(
    couponCode,                      // "DCARD-..."
    session.user.name,               // "John Doe"
    session.user.email,              // "john@example.com"
    transactionData.receiverName,    // "Julienn Blot"
    userId,                          // 12345
    parseInt(transactionData.amountSent) // 10000
  );
  
  // Smart Contract enregistre :
  // - cashbacks["DCARD-..."] = { senderName, email, beneficiary, amount, ... }
  // - users[12345].couponCodes.push("DCARD-...")
  
  // Redirection vers Review avec le coupon
  onContinue(couponCode);
}
```

**Transaction Blockchain :**
- ‚úÖ Coupon enregistr√© on-chain
- ‚úÖ Mapp√© au userId de l'utilisateur
- ‚úÖ Immuable et tra√ßable
- ‚úÖ Gas fees pay√©s par l'entreprise DCARD

#### **√âtape 4 : Review**
1. User voit le message de succ√®s ‚úÖ
2. Voit le r√©sum√© de la transaction
3. Voit le **code coupon** (d√©j√† enregistr√© on-chain)
4. Peut copier le code pour le partager au b√©n√©ficiaire
5. Peut t√©l√©charger le re√ßu
6. Peut d√©marrer un nouveau transfert

**Donn√©es affich√©es :**
- Nom du b√©n√©ficiaire
- T√©l√©phone du b√©n√©ficiaire
- Montant re√ßu
- M√©thode de paiement
- **Code coupon** (√† partager)

---

### 3Ô∏è‚É£ **HISTORIQUE DES TRANSACTIONS**

#### Page : `/history` (üîí Prot√©g√©e - n√©cessite connexion)

**2 ONGLETS DISTINCTS :**
- üìã **Coupons** : Transferts d'argent classiques
- üé´ **Tickets** : Achats marketplace avec produits

**Au chargement de l'onglet "Coupons" :**

```javascript
// 1. R√©cup√©rer userId depuis JWT
const userId = parseInt(session.user.id); // Ex: 12345

// 2. Charger les coupons de l'utilisateur depuis le smart contract (lecture, GRATUIT)
const { codes, amounts, createdAts, usedFlags, senderNames, beneficiaries, receiverCountries } = await getCouponsByUser(userId);
// Appelle getCouponsByUserId(userId) du smart contract

// 3. Formatter les donn√©es pour l'affichage
const userCoupons = codes.map((code, i) => ({
  code: code,
  amount: amounts[i],
  createdAt: createdAts[i],
  used: usedFlags[i],
  senderName: senderNames[i],
  beneficiary: beneficiaries[i],
  receiverCountry: receiverCountries[i]
}));

// 4. Afficher les accord√©ons de transactions
setCoupons(userCoupons);
```

**Au chargement de l'onglet "Tickets" :**

```javascript
// 1. R√©cup√©rer userId depuis JWT
const userId = parseInt(session.user.id); // Ex: 12345

// 2. Charger les tickets de l'utilisateur depuis le smart contract (lecture, GRATUIT)
const { codes, buyerNames, beneficiaries, totalAmounts, createdAts, usedFlags, productCounts } = await getMarketTicketsByUser(userId);
// Appelle getMarketTicketsByUserId(userId) du smart contract

// 3. Formatter les donn√©es pour l'affichage
const userTickets = codes.map((code, i) => ({
  code: code,
  buyerName: buyerNames[i],
  beneficiary: beneficiaries[i],
  totalAmount: totalAmounts[i],
  createdAt: createdAts[i],
  used: usedFlags[i],
  productCount: productCounts[i]
}));

// 4. Afficher les accord√©ons de tickets
setTickets(userTickets);
```

**Informations affich√©es pour chaque COUPON :**
- ‚úÖ Nom du b√©n√©ficiaire (depuis blockchain)
- ‚úÖ Pays du b√©n√©ficiaire
- ‚úÖ Statut (Available / Completed)
- ‚úÖ Montant envoy√© (EUR) - arrondi au sup√©rieur avec Math.ceil()
- ‚úÖ Date et heure
- ‚úÖ **Code coupon** (avec bouton copier)
- ‚úÖ Boutons d'action :
  - üîç **V√©rifier** : V√©rifie la validit√© du coupon + nom de famille
  - üí∞ **Encaisser** : Br√ªle le coupon (marque comme utilis√©)
- ‚úÖ Hash de cr√©ation et burn

**Informations affich√©es pour chaque TICKET :**
- ‚úÖ Nom de l'acheteur (depuis blockchain)
- ‚úÖ B√©n√©ficiaire
- ‚úÖ Statut (Available / Completed)
- ‚úÖ Montant total (EUR) - arrondi au sup√©rieur avec Math.ceil()
- ‚úÖ Nombre de produits command√©s
- ‚úÖ Date et heure
- ‚úÖ **Code ticket** (avec bouton copier)
- ‚úÖ Boutons d'action :
  - üîç **V√©rifier** : V√©rifie la validit√© du ticket
  - üì¶ **Encaisser** : Br√ªle le ticket (marque comme utilis√©)
- ‚úÖ Hash de cr√©ation et burn

**Synchronisation automatique :**
- La page charge automatiquement les donn√©es depuis la blockchain
- Le statut est mis √† jour en temps r√©el (Available ‚Üî Completed)
- Bouton "Rafra√Æchir" pour recharger les donn√©es manuellement

---

### 4Ô∏è‚É£ **UTILISATION DU CASHBACK (B√©n√©ficiaire) - COUPONS**

#### Page : `/history` - Onglet "Coupons" (üîí Prot√©g√©e - agent DCARD)

#### Sc√©nario : Le b√©n√©ficiaire vient r√©clamer son cashback

**√âtape 1 - V√©rification du coupon :**
```javascript
// Agent entre le code coupon + nom de famille du b√©n√©ficiaire
const code = "DCARD-1728567890-A5X9K";
const nomFamilleBeneficiaire = "Blot";

// V√©rifier la validit√© (lecture blockchain, GRATUIT)
const { isValid, senderName, beneficiary, amount, isUsed } = await verifyCouponCode(code, nomFamilleBeneficiaire);

if (isValid && !isUsed) {
  console.log(`‚úÖ Coupon valide !`);
  console.log(`Exp√©diteur : ${senderName}`);
  console.log(`B√©n√©ficiaire : ${beneficiary}`);
  console.log(`Montant : ${amount / 100} EUR`);
} else if (isUsed) {
  console.log(`‚ùå Coupon d√©j√† utilis√©`);
} else {
  console.log(`‚ùå Coupon invalide ou nom de famille incorrect`);
}
```

**√âtape 2 - Remise du cash physique :**
- L'agent DCARD v√©rifie l'identit√© du b√©n√©ficiaire (pi√®ce d'identit√©)
- Confirme que le nom de famille correspond au beneficiary enregistr√©
- Remet l'argent en cash
- Clique sur "Encaisser" dans l'historique

**√âtape 3 - Burn du coupon :**
```javascript
// Marquer le coupon comme utilis√© (Backend API paie les gas)
await burnCouponCode(code);

// Smart Contract :
// - cashbacks[code].used = true
// - √âmet √©v√©nement CouponBurned(code, amount, burner)
```

**√âtat final :**
- ‚úÖ Coupon marqu√© "Completed" dans l'historique
- ‚úÖ Ne peut plus √™tre r√©utilis√©
- ‚úÖ Hash de burn visible dans l'historique
- ‚úÖ Tra√ßabilit√© compl√®te on-chain

---

### 5Ô∏è‚É£ **MARKETPLACE - ACHAT DE PRODUITS**

#### Page : `/marketplace` (üîí Prot√©g√©e - n√©cessite connexion)

#### **√âtape 1 : S√©lection Pays et Ville**
1. User s√©lectionne un pays depuis la liste des 54 pays africains
2. **Gating obligatoire** : Une fois le pays s√©lectionn√©, l'interface propose les 3 plus grandes villes du pays
3. User doit choisir une ville parmi les 3 propos√©es
4. **Localisation persistante** : Le choix pays/ville est sauvegard√© dans localStorage
5. Seulement apr√®s cette s√©lection, les produits deviennent visibles et cliquables

**Donn√©es collect√©es :**
```javascript
{
  selectedCountry: "S√©n√©gal",
  selectedCity: "Dakar", // Une des 3 plus grandes villes
  locationSaved: true
}
```

#### **√âtape 2 : Navigation et Filtres**
1. **Filtres par cat√©gorie** : Mat√©riaux, Aliments, √ânergie, Divers
2. **Barre de recherche** pour trouver des produits sp√©cifiques
3. **S√©lecteur de devise** EUR/USD pour la diaspora
4. **Conversion automatique** des prix selon la devise choisie

#### **√âtape 3 : Ajout au Panier**
1. User clique sur un produit pour l'ajouter au panier
2. **Modal de confirmation** : "Produit ajout√© !"
3. Options : "Voir mon panier" ou "Continuer mes achats"
4. **Compteur panier** mis √† jour dans le header

#### **√âtape 4 : Page Panier (`/buy-material`)**
1. **R√©sum√© de commande** avec tous les articles
2. **Ajustement des quantit√©s** (+ / -) pour chaque produit
3. **Suppression d'articles** si n√©cessaire
4. **Calculs automatiques** :
   - Sous-total
   - TVA (20%)
   - Total final
5. **S√©lecteur de devise** pour conversion
6. **Badge r√©duction** 10% sur premi√®re commande
7. **Point relais** : "Retrait disponible dans nos points relais partenaires"

#### **√âtape 5 : Paiement**
1. User clique "Proc√©der au paiement"
2. **Modal de paiement** avec r√©sum√© de commande
3. **Int√©gration PaymentStep** pour les m√©thodes de paiement
4. **Enregistrement blockchain** apr√®s paiement r√©ussi

**üî• CE QUI SE PASSE (CRUCIAL) :**

```javascript
// 1. VALIDATION DU PAIEMENT
const paymentResult = await processPayment(...);

// 2. SI PAIEMENT VALID√â ‚úÖ
if (paymentResult.success) {
  // G√©n√©rer le code ticket unique
  const ticketCode = generateCouponCode();
  // Ex: "DCARD-1728567890-B7Z3M"
  
  // R√©cup√©rer userId depuis JWT
  const userId = parseInt(session.user.id); // Ex: 12345
  
  // R√©cup√©rer la localisation choisie
  const location = JSON.parse(localStorage.getItem('marketplaceLocation'));
  const receiverCountry = location.country; // "S√©n√©gal"
  const receiverCity = location.city;      // "Dakar"
  
  // Enregistrer on-chain (Backend API paie les gas fees)
  await recordMarketplacePurchase(
    ticketCode,                    // "DCARD-..."
    session.user.name,            // "John Doe"
    session.user.email,           // "john@example.com"
    'Marketplace DCARD',         // B√©n√©ficiaire
    receiverCountry,              // "S√©n√©gal"
    receiverCity,                 // "Dakar"
    userId,                       // 12345
    total,                        // Montant total
    products                      // [{name, quantity, price}, ...]
  );
  
  // Smart Contract enregistre :
  // - marketplacePurchases["DCARD-..."] = { buyerName, email, beneficiary, receiverCountry, receiverCity, userId, totalAmount, products[], ... }
  // - allMarketplaceCodes.push("DCARD-...")
  
  // Redirection vers Review avec le ticket
  onContinue(ticketCode);
}
```

**Transaction Blockchain :**
- ‚úÖ Ticket enregistr√© on-chain avec d√©tails des produits
- ‚úÖ Localisation (pays/ville) persist√©e
- ‚úÖ Mapp√© au userId de l'utilisateur
- ‚úÖ Immuable et tra√ßable
- ‚úÖ Gas fees pay√©s par l'entreprise DCARD

#### **√âtape 6 : Re√ßu de Commande**
1. **Modal de re√ßu** avec tous les d√©tails
2. **Informations de localisation** : Pays et ville s√©lectionn√©s
3. **Liste des produits** command√©s avec quantit√©s et prix
4. **Code ticket** unique avec bouton de copie
5. **Boutons d'action** :
   - "Imprimer" : T√©l√©charge le re√ßu PDF
   - "Fermer" : Ferme le modal
   - "Voir mes tickets" : Redirige vers l'historique

---

### 6Ô∏è‚É£ **UTILISATION DES TICKETS MARKETPLACE (B√©n√©ficiaire)**

#### Page : `/history` - Onglet "Tickets" (üîí Prot√©g√©e - agent DCARD)

#### Sc√©nario : Le b√©n√©ficiaire vient r√©cup√©rer sa commande au point relais

**√âtape 1 - V√©rification du ticket :**
```javascript
// Agent entre le code ticket
const code = "DCARD-1728567890-B7Z3M";

// V√©rifier la validit√© (lecture blockchain, GRATUIT)
const { isValid, buyerName, beneficiary, totalAmount, isUsed, productCount } = await verifyTicketCode(code);

if (isValid && !isUsed) {
  console.log(`‚úÖ Ticket valide !`);
  console.log(`Acheteur : ${buyerName}`);
  console.log(`B√©n√©ficiaire : ${beneficiary}`);
  console.log(`Montant total : ${totalAmount / 100} EUR`);
  console.log(`Nombre de produits : ${productCount}`);
} else if (isUsed) {
  console.log(`‚ùå Ticket d√©j√† utilis√©`);
} else {
  console.log(`‚ùå Ticket invalide`);
}
```

**√âtape 2 - Remise de la commande :**
- L'agent v√©rifie l'identit√© du b√©n√©ficiaire
- V√©rifie que les produits command√©s sont disponibles
- Remet la commande au point relais ou domicile
- Clique sur "Encaisser" dans l'historique

**√âtape 3 - Burn du ticket :**
```javascript
// Marquer le ticket comme utilis√© (Backend API paie les gas)
await burnTicketCode(code);

// Smart Contract :
// - marketplacePurchases[code].used = true
// - √âmet √©v√©nement TicketBurned(code, amount, burner)
```

**√âtat final :**
- ‚úÖ Ticket marqu√© "Completed" dans l'historique
- ‚úÖ Ne peut plus √™tre r√©utilis√©
- ‚úÖ Hash de burn visible dans l'historique
- ‚úÖ Tra√ßabilit√© compl√®te on-chain

---

## üîê S√©curit√© et Tra√ßabilit√©

### Avantages de la blockchain :

1. **Immuabilit√©** :
   - Impossible de modifier un coupon apr√®s cr√©ation
   - Historique permanent et v√©rifiable

2. **Tra√ßabilit√©** :
   - Chaque transaction est tra√ßable
   - √âv√©nements √©mis pour chaque action

3. **Anti-fraude** :
   - Un coupon ne peut √™tre utilis√© qu'une seule fois
   - V√©rification en temps r√©el de la validit√©

4. **Transparence** :
   - Toutes les transactions sont publiques sur l'explorer
   - Audit possible √† tout moment

### Protection des donn√©es :

- ‚úÖ JWT s√©curis√© (HttpOnly cookies)
- ‚úÖ Mots de passe hash√©s (bcrypt)
- ‚úÖ Routes prot√©g√©es (middleware NextAuth)
- ‚úÖ Gas fees pay√©s par l'entreprise (pas de wallet utilisateur)

---

## üìä Architecture technique

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FRONTEND (Next.js)                      ‚îÇ
‚îÇ  ‚Ä¢ Pages : Home, Login, Send Money, History                ‚îÇ
‚îÇ  ‚Ä¢ Auth : NextAuth (JWT avec userId)                        ‚îÇ
‚îÇ  ‚Ä¢ Lecture blockchain : cashbackService (GRATUIT)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  API BACKEND (Next.js API)                  ‚îÇ
‚îÇ  ‚Ä¢ /api/auth/register - Inscription                         ‚îÇ
‚îÇ  ‚Ä¢ /api/auth/[...nextauth] - Connexion                      ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/record-cashback - Enregistrer coupon     ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/record-marketplace-purchase - Ticket     ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/get-user-coupons - Coupons par userId    ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/get-market-tickets-by-user - Tickets     ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/verify-coupon - V√©rifier coupon          ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/burn-coupon - Encaisser coupon           ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/verify-ticket - V√©rifier ticket          ‚îÇ
‚îÇ  ‚Ä¢ /api/blockchain/burn-ticket - Encaisser ticket           ‚îÇ
‚îÇ  ‚Üí Wallet entreprise paie tous les gas fees                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          SMART CONTRACT (zkSync Era Sepolia)                ‚îÇ
‚îÇ  ‚Ä¢ CashbackRegistry.sol                                     ‚îÇ
‚îÇ  ‚Ä¢ Mappings :                                               ‚îÇ
‚îÇ    - userId ‚Üí User (balance, couponCodes)                   ‚îÇ
‚îÇ    - couponCode ‚Üí Cashback (details + receiverCountry)      ‚îÇ
‚îÇ    - ticketCode ‚Üí MarketplacePurchase (details + products)  ‚îÇ
‚îÇ  ‚Ä¢ Fonctions :                                              ‚îÇ
‚îÇ    - getCouponsByUserId(userId) ‚Üí tous d√©tails coupons      ‚îÇ
‚îÇ    - getMarketTicketsByUserId(userId) ‚Üí tous tickets        ‚îÇ
‚îÇ    - verifyCoupon(code, nom) ‚Üí validit√© + d√©tails           ‚îÇ
‚îÇ    - burnCoupon(code) ‚Üí marque utilis√©                      ‚îÇ
‚îÇ    - verifyTicket(code) ‚Üí validit√© + d√©tails                ‚îÇ
‚îÇ    - burnTicket(code) ‚Üí marque utilis√©                      ‚îÇ
‚îÇ  ‚Ä¢ Events :                                                 ‚îÇ
‚îÇ    - CashbackRecorded, CouponBurned                         ‚îÇ
‚îÇ    - MarketplacePurchaseRecorded, TicketBurned              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéâ R√©sum√© du Flow

**WORKFLOW COUPONS (Transfert d'argent) :**
1. **User s'inscrit** ‚Üí userId cr√©√©, stock√© dans JWT ‚úÖ
2. **User envoie de l'argent** ‚Üí Formulaire multi-√©tapes ‚úÖ
3. **Paiement valid√©** ‚Üí Coupon g√©n√©r√© + enregistr√© on-chain ‚úÖ
4. **Coupon affich√©** ‚Üí User peut le partager au b√©n√©ficiaire ‚úÖ
5. **B√©n√©ficiaire r√©clame** ‚Üí Agent v√©rifie (code + nom) + remise cash + burn ‚úÖ
6. **Historique** ‚Üí User voit tous ses coupons depuis blockchain (onglet Coupons) ‚úÖ

**WORKFLOW TICKETS (Marketplace) :**
1. **User s'inscrit** ‚Üí userId cr√©√©, stock√© dans JWT ‚úÖ
2. **User ach√®te des produits** ‚Üí Panier + formulaire multi-√©tapes ‚úÖ
3. **Paiement valid√©** ‚Üí Ticket g√©n√©r√© + enregistr√© on-chain avec produits ‚úÖ
4. **Ticket affich√©** ‚Üí Re√ßu imprimable avec d√©tails commande ‚úÖ
5. **B√©n√©ficiaire r√©cup√®re** ‚Üí Agent v√©rifie ticket + remet commande + burn ‚úÖ
6. **Historique** ‚Üí User voit tous ses tickets depuis blockchain (onglet Tickets) ‚úÖ

**Tout est trac√©, s√©curis√©, et d√©centralis√© !** üîêüåç‚ú®



